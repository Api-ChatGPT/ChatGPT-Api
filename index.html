<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Backup em txt (formato texto simples)</title>
</head>
<body>

<h2>Status:</h2>
<div id="status">Iniciando...</div>

<script>
  const autoresponderURL = "https://chatgpt-api-9a719-default-rtdb.firebaseio.com/autoresponder.json";
  const txtURL = "https://chatgpt-api-9a719-default-rtdb.firebaseio.com/backup/server.json";

  async function salvarMensagem() {
    try {
      document.getElementById("status").innerText = "Buscando mensagem...";

      // Pega último ID do autoresponder
      const resAuto = await fetch(autoresponderURL);
      const dadosAuto = await resAuto.json();
      const ids = Object.keys(dadosAuto);
      const ultimoID = ids[ids.length - 1];

      const resMsg = await fetch(`https://chatgpt-api-9a719-default-rtdb.firebaseio.com/autoresponder/${ultimoID}/query/message.json`);
      const mensagem = await resMsg.json();

      if (!mensagem) throw new Error("Mensagem vazia ou não encontrada.");

      // Busca txt atual
      const resTxt = await fetch(txtURL);
      let txt = "";
      try {
        const json = await resTxt.json();
        txt = json.txt || "";
      } catch {
        txt = "";
      }

      // Verifica se já existe
      if (txt.includes(mensagem)) {
        document.getElementById("status").innerText = "Mensagem já existe.";
        return;
      }

      // Adiciona mensagem nova
      const novoTxt = txt ? `${txt},${mensagem}` : mensagem;

      // Salva no Firebase
      await fetch(txtURL, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ txt: novoTxt })
      });

      document.getElementById("status").innerText = "Mensagem salva com sucesso!";
    } catch (err) {
      document.getElementById("status").innerText = "Erro: " + err.message;
      console.error(err);
    }
  }

  salvarMensagem();
</script>

</body>
</html>