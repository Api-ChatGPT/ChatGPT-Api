<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sistema Sincronizado com Backup</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #status { font-weight: bold; color: #333; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Status:</h2>
  <div id="status">Iniciando...</div>

  <script>
    const api1 = 'https://chatgpt-api-9a719-default-rtdb.firebaseio.com/api/chat/per.json';
    const api2 = 'https://server-chatgpt-api-default-rtdb.firebaseio.com/api/chat/per.json';
    const api3 = 'https://server-chatgpt-api-default-rtdb.firebaseio.com/api/chat/res.json';
    const api4 = 'https://chatgpt-api-9a719-default-rtdb.firebaseio.com/api/chat/res.json';
    const autoresponderURL = "https://server-chatgpt-api-default-rtdb.firebaseio.com/autoresponder.json";
    const backupBaseURL = "https://server-chatgpt-api-default-rtdb.firebaseio.com/backup";
    const perguntaURL = "https://server-chatgpt-api-default-rtdb.firebaseio.com/api/chat/per.json";

    function toBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    async function salvarBackup(pergunta, resposta) {
      const idBase64 = toBase64(pergunta);
      const destino = `${backupBaseURL}/${idBase64}.json`;

      const dados = { id: idBase64, pergunta, resposta };
      await fetch(destino, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dados)
      });
    }

    async function verificarPergunta(pergunta) {
      const idBase64 = toBase64(pergunta);
      const urlPesquisa = `${backupBaseURL}/${idBase64}.json`;

      try {
        const resposta = await fetch(urlPesquisa);
        const dados = await resposta.json();
        return dados;  // Retorna os dados encontrados ou 'undefined' se não encontrado
      } catch (err) {
        console.error("Erro ao verificar pergunta:", err);
        return null; // Se não encontrar ou ocorrer erro
      }
    }

    async function enviarResposta(pergunta, resposta) {
      const perguntaAtual = await verificarPergunta(pergunta);
      if (perguntaAtual) {
        // Se encontrar a pergunta no servidor, envia a resposta para a API de chat
        const idBase64 = toBase64(pergunta);
        const destinoResposta = `${api3}`; // Endereço da API de respostas

        const dadosResposta = {
          pergunta: pergunta,
          resposta: resposta,
          id: idBase64,
        };

        await fetch(destinoResposta, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dadosResposta),
        });
        console.log("Resposta enviada para a API.");
      } else {
        console.log("Pergunta não encontrada no servidor.");
      }
    }

    async function sistemaPrincipal() {
      try {
        const [res1, res2, res3, res4] = await Promise.all([
          fetch(api1).then(r => r.json()),
          fetch(api2).then(r => r.json()),
          fetch(api3).then(r => r.json()),
          fetch(api4).then(r => r.json())
        ]);

        // Sistema 1: per de api1 ≠ per de api2 => envia para api2
        if (JSON.stringify(res1) !== JSON.stringify(res2)) {
          await fetch(api2, {
            method: "PUT",
            body: JSON.stringify(res1)
          });
        }

        // Sistema 2: res de api3 ≠ res de api4 => envia para api4
        if (JSON.stringify(res3) !== JSON.stringify(res4)) {
          await fetch(api4, {
            method: "PUT",
            body: JSON.stringify(res3)
          });

          // Faz backup também se foi enviada resposta nova
          const perguntaAtual = await fetch(perguntaURL).then(r => r.json());
          if (typeof perguntaAtual === "string" && perguntaAtual.trim() !== "") {
            await salvarBackup(perguntaAtual, res3);
            await enviarResposta(perguntaAtual, res3);  // Envia a resposta para a API
          }
        }

        document.getElementById("status").innerText = "Sincronização e backup concluídos.";
      } catch (err) {
        document.getElementById("status").innerText = "Erro na sincronização.";
        console.error(err);
      }
    }

    async function sistemaAutoresponder() {
      try {
        const resAuto = await fetch(autoresponderURL);
        const dadosAuto = await resAuto.json();
        const ids = Object.keys(dadosAuto || {});
        const ultimoID = ids[ids.length - 1];
        const resMsg = await fetch(`https://server-chatgpt-api-default-rtdb.firebaseio.com/autoresponder/${ultimoID}/query/message.json`);
        const mensagem = await resMsg.json();

        if (!mensagem || mensagem.trim() === "") return;

        const perguntaAtual = await fetch(perguntaURL).then(r => r.json());
        if (!perguntaAtual || perguntaAtual.trim() === "") return;

        await salvarBackup(perguntaAtual, mensagem);

        // Exclui o nó do autoresponder após o backup
        await fetch(`https://server-chatgpt-api-default-rtdb.firebaseio.com/autoresponder/${ultimoID}.json`, {
          method: "DELETE"
        });

        // Envia a resposta do autoresponder
        await enviarResposta(perguntaAtual, mensagem);
      } catch (err) {
        console.error("Erro no sistema de autoresponder:", err);
      }
    }

    sistemaPrincipal();
    sistemaAutoresponder();

    setTimeout(() => {
      window.location.href = "https://api-chatgpt.github.io/ChatGPT-Api/index.html";
    }, 1000);
  </script>
</body>
</html>