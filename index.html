<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sistema Web em Segundo Plano</title>
</head>
<body>
  <h2>Status:</h2>
  <div id="status">Iniciando...</div>

  <script>
    const perguntaAPI = 'https://chatgpt-api-9a719-default-rtdb.firebaseio.com/api/chat/per.json';
    const perguntaServidor = 'https://server-chatgpt-api-default-rtdb.firebaseio.com/api/chat/per.json';
    const perguntaEspelho = 'https://server-chatgpt-api-default-rtdb.firebaseio.com/api/chat/pes.json';
    const respostaServidor = 'https://server-chatgpt-api-default-rtdb.firebaseio.com/api/chat/res.json';
    const respostaAPI = 'https://chatgpt-api-9a719-default-rtdb.firebaseio.com/api/chat/res.json';
    const backupURL = 'https://server-chatgpt-api-default-rtdb.firebaseio.com/backup';

    const autoresponderURL = "https://server-chatgpt-api-default-rtdb.firebaseio.com/autoresponder.json";

    function toBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    async function verificarBackup(pergunta) {
      const idBase64 = toBase64(pergunta);
      const urlBackup = `${backupURL}/${idBase64}.json`;

      try {
        const dadosBackup = await fetch(urlBackup).then(r => r.json());

        if (dadosBackup && dadosBackup.resposta) {
          await fetch(respostaAPI, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dadosBackup.resposta)
          });
          document.body.innerHTML += '<p>Resposta do backup enviada para API.</p>';
        } else {
          const waURL = "https://wa.me/5511972553036?text=" + encodeURIComponent(pergunta);
          document.body.innerHTML += '<p>Sem resposta no backup. Abrindo WhatsApp...</p>';
          window.open(waURL, "_blank");
        }
      } catch (err) {
        document.body.innerHTML += '<p style="color:red;">Erro no backup: ' + err.message + '</p>';
      }
    }

    async function syncData() {
      try {
        const [pergunta, espelho, respostaSrv, respostaApp] = await Promise.all([
          fetch(perguntaAPI).then(r => r.json()),
          fetch(perguntaEspelho).then(r => r.json()),
          fetch(respostaServidor).then(r => r.json()),
          fetch(respostaAPI).then(r => r.json())
        ]);

        const perguntaValida = typeof pergunta === "string" && pergunta.trim() !== "";

        if (JSON.stringify(pergunta) === JSON.stringify(espelho) && perguntaValida) {
          document.body.innerHTML += '<p>per == pes → verificando backup...</p>';
          await verificarBackup(pergunta);
        } else if (JSON.stringify(respostaSrv) === JSON.stringify(respostaApp) && perguntaValida) {
          document.body.innerHTML += '<p>res == res → verificando backup...</p>';
          await verificarBackup(pergunta);
        }

        if (JSON.stringify(pergunta) !== JSON.stringify(espelho)) {
          await fetch(perguntaServidor, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pergunta)
          });
          document.body.innerHTML += '<p>Pergunta enviada para o servidor.</p>';
        }

        if (JSON.stringify(respostaSrv) !== JSON.stringify(respostaApp)) {
          await fetch(respostaAPI, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(respostaSrv)
          });
          document.body.innerHTML += '<p>Resposta enviada para API.</p>';
        }

      } catch (err) {
        document.body.innerHTML += '<p style="color:red;">Erro no sync: ' + err.message + '</p>';
      }
    }

    async function salvarBackup(pergunta, resposta) {
      const idBase64 = toBase64(pergunta);
      const destino = `${backupURL}/${idBase64}.json`;

      const dados = {
        id: idBase64,
        pergunta: pergunta,
        resposta: resposta
      };

      await fetch(destino, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dados)
      });

      document.body.innerHTML += "<p>Backup salvo com sucesso.</p>";
    }

    async function sistemaAutoresponder() {
      try {
        const resAuto = await fetch(autoresponderURL);
        const dadosAuto = await resAuto.json();
        const ids = Object.keys(dadosAuto);
        const ultimoID = ids[ids.length - 1];

        const resMsg = await fetch(`https://server-chatgpt-api-default-rtdb.firebaseio.com/autoresponder/${ultimoID}/query/message.json`);
        const mensagem = await resMsg.json();

        const resPergunta = await fetch(perguntaURL);
        const pergunta = await resPergunta.json();

        if (mensagem && mensagem.trim() !== "" && pergunta && pergunta.trim() !== "") {
          await salvarBackup(pergunta, mensagem);
        }
      } catch (err) {
        document.body.innerHTML += '<p style="color:red;">Erro autoresponder: ' + err.message + '</p>';
      }
    }

    // Executa os dois sistemas ao mesmo tempo
    syncData();
    sistemaAutoresponder();

    setTimeout(() => {
      window.location.href = "https://api-chatgpt.github.io/ChatGPT-Api/index.html";
    }, 1000);
  </script>
</body>
</html>