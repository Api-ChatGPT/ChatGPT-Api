<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Backup com ID Base64</title>
</head>
<body>

<h2>Status:</h2>
<div id="status">Iniciando...</div>

<script>
  const autoresponderURL = "https://server-chatgpt-api-default-rtdb.firebaseio.com/autoresponder.json";

  function toBase64(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }

  async function salvarMensagem() {
    try {
      document.getElementById("status").innerText = "Buscando mensagem...";

      const resAuto = await fetch(autoresponderURL);
      const dadosAuto = await resAuto.json();
      if (!dadosAuto || Object.keys(dadosAuto).length === 0) {
        throw new Error("Nenhuma mensagem encontrada.");
      }

      const ids = Object.keys(dadosAuto);
      const ultimoID = ids[ids.length - 1];

      const resMsg = await fetch(`https://server-chatgpt-api-default-rtdb.firebaseio.com/autoresponder/${ultimoID}/query/message.json`);
      const mensagemStr = await resMsg.json();

      if (!mensagemStr || mensagemStr.trim() === "") throw new Error("Mensagem vazia ou não encontrada.");

      // Tenta converter mensagem em JSON
      let mensagemJSON;
      try {
        mensagemJSON = JSON.parse(mensagemStr);
      } catch {
        throw new Error("Mensagem não está em formato JSON.");
      }

      const pergunta = mensagemJSON.S1;
      const resposta = mensagemJSON.S2;

      if (!pergunta || !resposta) throw new Error("Campos S1 ou S2 ausentes.");

      const idBase64 = toBase64(pergunta);
      const destinoURL = `https://server-chatgpt-api-default-rtdb.firebaseio.com/backup/${idBase64}.json`;

      const dados = {
        id: idBase64,
        pergunta: pergunta,
        resposta: resposta
      };

      await fetch(destinoURL, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(dados)
      });

      document.getElementById("status").innerText = "Mensagem salva com sucesso!";
    } catch (err) {
      document.getElementById("status").innerText = "Erro: " + err.message;
      console.error(err);
    }
  }

  salvarMensagem();
</script>

</body>
</html>