<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Buscar e Responder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #status {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<h2>Status:</h2>
<div id="status">Iniciando...</div>

<script>
  const apiPerguntaURL = "https://chatgpt-api-9a719-default-rtdb.firebaseio.com/api/chat/per.json";
  const apiRespostaURL = "https://chatgpt-api-9a719-default-rtdb.firebaseio.com/api/chat/res.json";
  const apiTmpPerguntaURL = "https://chatgpt-api-9a719-default-rtdb.firebaseio.com/api/chat/tmp.json";
  const baseBackupURL = "https://server-chatgpt-api-default-rtdb.firebaseio.com/backup";

  function toBase64(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }

  async function salvarTmpPergunta(pergunta) {
    try {
      await fetch(apiTmpPerguntaURL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(pergunta)
      });
    } catch (e) {
      console.error("Erro ao salvar pergunta temporária:", e);
    }
  }

  async function buscarEResponder() {
    let pergunta = "";

    try {
      document.getElementById("status").innerText = "Buscando pergunta...";

      // Buscar pergunta
      const perguntaRes = await fetch(apiPerguntaURL);
      pergunta = await perguntaRes.text();

      if (!pergunta || pergunta.trim() === "") {
        document.getElementById("status").innerText = "Nenhuma pergunta encontrada.";
        return;
      }

      // Verifica se é repetida
      const tmpRes = await fetch(apiTmpPerguntaURL);
      const perguntaTmp = await tmpRes.text();

      if (pergunta === perguntaTmp) {
        document.getElementById("status").innerText = "Pergunta já processada.";
        setTimeout(() => {
          window.location.href = "https://api-chatgpt.github.io/ChatGPT-Api/index.html";
        }, 2000);
        return;
      }

      const idBase64 = toBase64(pergunta);
      const backupRes = await fetch(`${baseBackupURL}/${idBase64}.json`);
      const dadosBackup = await backupRes.json();

      if (dadosBackup && dadosBackup.resposta) {
        const resposta = dadosBackup.resposta;

        // Verifica se a resposta já foi enviada
        const resExistente = await fetch(apiRespostaURL);
        const respostaAnterior = await resExistente.text();

        if (respostaAnterior === resposta) {
          document.getElementById("status").innerText = "Resposta já enviada anteriormente.";
          setTimeout(() => {
            window.location.href = "https://api-chatgpt.github.io/ChatGPT-Api/index.html";
          }, 2000);
          return;
        }

        // Salva nova pergunta temporária
        await salvarTmpPergunta(pergunta);

        // Enviar nova resposta
        const envio = await fetch(apiRespostaURL, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(resposta)
        });

        if (!envio.ok) throw new Error("Erro ao enviar resposta.");

        document.getElementById("status").innerText = "Resposta enviada. Abrindo WhatsApp...";
        window.open("https://wa.me/18002428478?text=" + encodeURIComponent(pergunta), "_blank");

      } else {
        document.getElementById("status").innerText = "Resposta não encontrada.";
      }

    } catch (err) {
      console.error("Erro:", err);
      document.getElementById("status").innerText = "Erro ao processar.";
    } finally {
      setTimeout(() => {
        window.location.href = "https://api-chatgpt.github.io/ChatGPT-Api/index.html";
      }, 2000);
    }
  }

  buscarEResponder();
</script>

</body>
</html>