<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Buscar e Responder</title>
</head>
<body>

<h2>Status:</h2>
<div id="status">Iniciando...</div>

<script>
  const apiPerguntaURL = "https://chatgpt-api-9a719-default-rtdb.firebaseio.com/api/chat/per.json";
  const apiRespostaURL = "https://chatgpt-api-9a719-default-rtdb.firebaseio.com/api/chat/res.json";
  const baseBackupURL = "https://server-chatgpt-api-default-rtdb.firebaseio.com/backup";

  function toBase64(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }

  async function copiarParaAreaDeTransferencia(texto) {
    try {
      await navigator.clipboard.writeText(texto);
      console.log("Texto copiado: ", texto);
    } catch (err) {
      console.error("Erro ao copiar: ", err);
    }
  }

  async function buscarEResponder() {
    try {
      document.getElementById("status").innerText = "Buscando pergunta...";

      // 1. Buscar pergunta
      const resPergunta = await fetch(apiPerguntaURL);
      const pergunta = await resPergunta.json();

      if (!pergunta || pergunta.trim() === "") throw new Error("Pergunta vazia ou não encontrada.");

      // 2. Gerar ID base64
      const idBase64 = toBase64(pergunta);

      // 3. Buscar resposta no backup
      const resBackup = await fetch(`${baseBackupURL}/${idBase64}.json`);
      const dados = await resBackup.json();

      if (!dados || !dados.resposta) {
        await copiarParaAreaDeTransferencia(pergunta);
        throw new Error("Resposta não encontrada no backup. Pergunta copiada para a área de transferência.");
      }

      const resposta = dados.resposta;

      // 4. Enviar resposta para a API
      await fetch(apiRespostaURL, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(resposta)
      });

      document.getElementById("status").innerText = "Resposta enviada com sucesso!";
    } catch (err) {
      document.getElementById("status").innerText = "Erro: " + err.message;
      console.error(err);
    }
  }

  buscarEResponder();
</script>

</body>
</html>